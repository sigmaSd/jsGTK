# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

# This workflow will install Deno/Bun then run linting and tests.
# For more information see: https://github.com/denoland/setup-deno

name: CI

on:
  push:
  pull_request:
    branches: ["master", "dev"]

permissions:
  contents: read

jobs:
  test:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Setup repo
        uses: actions/checkout@v4

      - name: Cache MSYS2 (Windows)
        if: runner.os == 'Windows'
        uses: actions/cache@v3
        with:
          path: C:\tools\msys64
          key: ${{ runner.os }}-msys2-gtk4-${{ hashFiles('.github/workflows/ci.yml') }}
          restore-keys: |
            ${{ runner.os }}-msys2-gtk4-

      - name: Install GTK dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-4-dev libadwaita-1-dev xvfb

      - name: Install GTK dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install gtk4 libadwaita
          echo "DYLD_LIBRARY_PATH=/opt/homebrew/lib:/usr/local/lib:$DYLD_LIBRARY_PATH" >> $GITHUB_ENV

      - name: Install GTK dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          if (!(Test-Path "C:\tools\msys64\usr\bin\bash.exe")) {
            choco install msys2 -y
          }
          C:\tools\msys64\usr\bin\bash.exe -lc "pacman -Syu --noconfirm"
          C:\tools\msys64\usr\bin\bash.exe -lc "pacman -S --noconfirm mingw-w64-x86_64-gtk4 mingw-w64-x86_64-libadwaita"
          echo "C:\tools\msys64\mingw64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Run tests
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            xvfb-run -a deno task test
          else
            deno task test
          fi
        shell: bash
